# ========
# SERVICES
# ========
# Crawling service
apiVersion: v1
kind: Service
metadata:
  name: crawling-service
spec:
  selector:
    service: crawling-service
  ports:
    - name: crawling-port
      protocol: TCP
      port: 8080
      targetPort: 8080
---
# Balancing service
apiVersion: v1
kind: Service
metadata:
  name: balancing-service
spec:
  selector:
    service: balancing-service
  ports:
    - name: balancing-port
      protocol: TCP
      # Inside the cluster, what port does the service expose?
      port: 9999
      # Which port do pods selected by this service expose?
      targetPort: 9999
---
# URL Map service
apiVersion: v1
kind: Service
metadata:
  name: urlmap-service
spec:
  selector:
    service: urlmap-service
  ports:
    - name: urlmap-port
      protocol: TCP
      port: 6379
      targetPort: 6379
---
# ====
# PODS
# ====
# URL Map (Redis) pod
apiVersion: v1
kind: Pod
metadata:
  name: urlmap-pod
  labels:
    app: bingo
    service: urlmap-service
spec:
  volumes:
    - name: urlmap-storage
      persistentVolumeClaim:
        claimName: pvc-urlmap
    - name: redisconfig
      configMap:
        name: redisconfig
  containers:
  - name: urlmap
    image: redis:latest
    args:
      - /etc/redis/redis.conf
    volumeMounts:
    - name: urlmap-storage
      mountPath: /data
      subPath: urlmap
    - name: redisconfig
      mountPath: /etc/redis
    ports:
    - containerPort: 6379
      name: urlmap-port
      protocol: TCP
---
# Domain Balancer
apiVersion: v1
kind: Pod
metadata:
  name: domain-balancer-pod
  labels:
    app: bingo
    service: balancing-service
spec:
  # nslookup balancer-host.default.svc.cluster.local
  hostname: balancer-host
  subdomain: default
  containers:
  - name: domain-balancer
    image: bingocrawler/balancer:latest
    args: ["$(ENV_FILE)"]
    env:
    - name: ENV_FILE
      valueFrom:
        secretKeyRef:
          name: deploy
          key: ENV_FILE
    ports:
    - name: balancing-port
      containerPort: 9999
      protocol: TCP
---
# =======
# STORAGE
# =======
# Storage class for AWS deploy
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: sc-aws
  labels:
    app: bingo
    service: urlmap-service
reclaimPolicy: Retain
provisioner: kubernetes.io/aws-ebs
allowVolumeExpansion: true
parameters:
  type: io1
  iopsPerGB: "10"
  fsType: ext4
  encrypted: "false"
---
# Storage class for local deploy
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: sc-local
  labels:
    app: bingo
    service: urlmap-service
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: Immediate
reclaimPolicy: Retain
allowVolumeExpansion: true
---
# Persistent volume for minikube (local)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-local
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: sc-local
  # https://kubernetes.io/docs/setup/learning-environment/minikube/#persistent-volumes
  hostPath:
    path: /data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - minikube
---
# Persistent volume claim for URL Map (Redis)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-urlmap
  labels:
    app: bingo
    service: urlmap-service
spec:
  accessModes: [ReadWriteOnce]
# CHANGE WHEN IN AWS VS. LOCAL:
  # storageClassName: 'sc-local'
  storageClassName: 'sc-aws'
  resources:
    requests:
      storage: 10Gi
---
# ======================
# DEPLOYMENTS / REPLICAS
# ======================
# CRAWLER
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crawler-pod
spec:
  selector:
    matchLabels:
      app: bingo
      service: crawling-service
  replicas: 2
  template:
    metadata:
      labels:
        app: bingo
        service: crawling-service
    spec:
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 90
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: service
                  operator: NotIn
                  values:
                  - urlmap-service
              topologyKey: "kubernetes.io/hostname"
      containers:
      - name: crawler-container
        image: bingocrawler/crawler:latest
        args: ["$(ENV_FILE)"]
        env:
        - name: ENV_FILE
          valueFrom:
            secretKeyRef:
              name: deploy
              key: ENV_FILE
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: AWS_SECRET_ACCESS_KEY
